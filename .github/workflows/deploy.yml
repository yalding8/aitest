name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Digital Ocean Droplet
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          # å…³é”®ä¿®æ”¹ï¼šå¯ç”¨è°ƒè¯•æ¨¡å¼ï¼Œè¿™ä¼šæ‰“å°å‡ºå…·ä½“çš„è¿æ¥é”™è¯¯åŸå› 
          debug: true
          # å¢åŠ è¶…æ—¶æ—¶é—´
          timeout: 30m
          command_timeout: 30m
          script: |
            echo "ğŸš€ å¼€å§‹è¿æ¥æœåŠ¡å™¨..."
            # åœæ­¢è„šæœ¬æ‰§è¡Œå¦‚æœå‡ºç°é”™è¯¯
            set -e
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /root/aitest
            
            # å¼ºåˆ¶é‡ç½®ä»£ç ï¼Œé˜²æ­¢å†²çª
            echo "ğŸ“¥ å¼ºåˆ¶åŒæ­¥æœ€æ–°ä»£ç ..."
            git fetch --all
            git reset --hard origin/main
            
            # æ›´æ–°åç«¯
            echo "ğŸ”§ æ›´æ–°åç«¯..."
            cd exam-backend
            npm install --production
            
            # é‡å¯åç«¯æœåŠ¡
            echo "â™»ï¸ é‡å¯åç«¯æœåŠ¡..."
            pm2 restart aitest-backend || pm2 start server.js --name aitest-backend
            
            # æ›´æ–°å‰ç«¯
            echo "ğŸ¨ æ„å»ºå‰ç«¯..."
            cd ../exam-frontend
            npm install
            npm run build
            
            # æ£€æŸ¥çŠ¶æ€
            echo "âœ… éƒ¨ç½²å®Œæˆï¼æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            pm2 status
