name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "
            set -e
            
            # 1. æ›´æ–°ä»£ç 
            cd /root/aitest
            echo 'ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ...'
            git fetch --all
            git reset --hard origin/main
            
            # 2. åç«¯éƒ¨ç½²
            echo 'ğŸ”§ åç«¯æ„å»ºä¸­...'
            cd exam-backend
            npm install --production
            pm2 restart aitest-backend || pm2 start server.js --name aitest-backend
            
            # 3. å‰ç«¯éƒ¨ç½²
            echo 'ğŸ¨ å‰ç«¯æ„å»ºä¸­...'
            cd ../exam-frontend
            npm install
            npm run build
            
            # å…³é”®ä¿®å¤ï¼šå°†æ„å»ºäº§ç‰©å¤åˆ¶åˆ° Nginx ç›®å½•
            echo 'ğŸšš éƒ¨ç½²å‰ç«¯æ–‡ä»¶åˆ° Nginx...'
            mkdir -p /var/www/aitest
            rm -rf /var/www/aitest/*
            cp -r dist/* /var/www/aitest/
            
            echo 'âœ… éƒ¨ç½²æˆåŠŸï¼'
            pm2 status
          "
