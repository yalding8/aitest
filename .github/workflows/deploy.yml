name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Digital Ocean Droplet
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # åœæ­¢è„šæœ¬æ‰§è¡Œå¦‚æœå‡ºç°é”™è¯¯
            set -e
            
            echo "ğŸš€ å¼€å§‹è‡ªåŠ¨éƒ¨ç½²..."
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /root/aitest
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–ä»£ç ..."
            git pull origin main
            
            # æ›´æ–°åç«¯
            echo "ğŸ”§ æ›´æ–°åç«¯..."
            cd exam-backend
            npm install --production
            
            # é‡å¯åç«¯æœåŠ¡
            echo "â™»ï¸ é‡å¯åç«¯æœåŠ¡..."
            pm2 restart aitest-backend || pm2 start server.js --name aitest-backend
            
            # æ›´æ–°å‰ç«¯
            echo "ğŸ¨ æ„å»ºå‰ç«¯..."
            cd ../exam-frontend
            npm install
            npm run build
            
            # é‡å¯Nginx
            # echo "ğŸŒ é‡å¯Nginx..."
            # sudo systemctl reload nginx
            
            # æ£€æŸ¥çŠ¶æ€
            echo "âœ… éƒ¨ç½²å®Œæˆï¼æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            pm2 status
