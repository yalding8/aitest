name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh/
          # å†™å…¥ç§é’¥
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          # æ·»åŠ ä¸»æœºæŒ‡çº¹
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          
          echo "ğŸ” æ­£åœ¨æ£€æŸ¥ç§é’¥æ ¼å¼..."
          # éªŒè¯ç§é’¥æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ (å¦‚æœè¿™é‡ŒæŠ¥é”™ï¼Œè¯´æ˜ Secrets é‡Œçš„å†…å®¹æ ¼å¼è¿˜æ˜¯ä¸å¯¹)
          ssh-keygen -y -f ~/.ssh/id_ed25519 > /dev/null && echo "âœ… ç§é’¥æ ¼å¼æœ‰æ•ˆ" || echo "âŒ ç§é’¥æ–‡ä»¶æŸåï¼è¯·æ£€æŸ¥ Secrets å¤åˆ¶è¿‡ç¨‹"

      - name: Connection Test (Debug)
        run: |
          echo "ğŸš€ æ­£åœ¨å°è¯•è¿æ¥æœåŠ¡å™¨ (è¯¦ç»†æ¨¡å¼)..."
          # -v å‚æ•°ä¼šæ‰“å°å‡ºè¿æ¥è¿‡ç¨‹ï¼ˆæ˜¯ç½‘ç»œä¸é€šè¿˜æ˜¯å¯†ç é”™è¯¯ï¼‰
          ssh -v -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "echo 'âœ… è¿æ¥æˆåŠŸï¼'"

      - name: Deploy Script
        if: success()
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "
            set -e
            cd /root/aitest
            git fetch --all
            git reset --hard origin/main
            cd exam-backend
            npm install --production
            pm2 restart aitest-backend || pm2 start server.js --name aitest-backend
            cd ../exam-frontend
            npm install
            npm run build
            echo 'âœ… éƒ¨ç½²å…¨éƒ¨å®Œæˆ'
          "
