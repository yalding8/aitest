name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH Key
        run: |
          # åˆ›å»º SSH ç›®å½•
          mkdir -p ~/.ssh/
          
          # å°† Secret é‡Œçš„ç§é’¥å†™å…¥æ–‡ä»¶
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          
          # è®¾ç½®æ­£ç¡®çš„æƒé™ï¼ˆéå¸¸é‡è¦ï¼‰
          chmod 600 ~/.ssh/id_ed25519
          
          # å°†æœåŠ¡å™¨ IP åŠ å…¥å¯ä¿¡åˆ—è¡¨ï¼Œé¿å…é¦–æ¬¡è¿æ¥è¯¢é—®
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy Script
        run: |
          echo "ğŸš€ å¼€å§‹è¿æ¥æœåŠ¡å™¨..."
          
          # ç›´æ¥ä½¿ç”¨ ssh å‘½ä»¤æ‰§è¡Œè¿œç¨‹è„šæœ¬
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "
            set -e
            
            # 1. è¿›å…¥ç›®å½•
            cd /root/aitest
            
            # 2. å¼ºåˆ¶æ‹‰å–æœ€æ–°ä»£ç 
            echo 'ğŸ“¥ æ‹‰å–ä»£ç ...'
            git fetch --all
            git reset --hard origin/main
            
            # 3. åç«¯éƒ¨ç½²
            echo 'ğŸ”§ éƒ¨ç½²åç«¯...'
            cd exam-backend
            npm install --production
            pm2 restart aitest-backend || pm2 start server.js --name aitest-backend
            
            # 4. å‰ç«¯éƒ¨ç½²
            echo 'ğŸ¨ éƒ¨ç½²å‰ç«¯...'
            cd ../exam-frontend
            npm install
            npm run build
            
            echo 'âœ… éƒ¨ç½²å…¨éƒ¨å®Œæˆï¼'
          "
